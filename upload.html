<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Media Upload</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
			min-height: 100vh;
			color: #fff;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 20px
		}

		.container {
			width: 100%;
			max-width: 400px;
			display: flex;
			flex-direction: column;
			gap: 20px
		}

		.header {
			text-align: center;
			padding: 12px 0
		}

		.header h1 {
			font-size: 20px;
			font-weight: 600;
			color: #00d9ff
		}

		.status-bar {
			background: rgba(255, 255, 255, .1);
			border-radius: 12px;
			padding: 12px 16px;
			display: flex;
			justify-content: space-between;
			align-items: center
		}

		.status-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: #00ff88;
			animation: pulse 2s infinite
		}

		@keyframes pulse {

			0%,
			100% {
				opacity: 1
			}

			50% {
				opacity: .5
			}
		}

		.status-text {
			font-size: 13px;
			color: rgba(255, 255, 255, .8)
		}

		.upload-area {
			background: rgba(255, 255, 255, .05);
			border: 2px dashed rgba(255, 255, 255, .2);
			border-radius: 12px;
			padding: 24px 16px;
			text-align: center;
			cursor: pointer;
			transition: all .3s
		}

		.upload-area:hover,
		.upload-area.dragover {
			border-color: #00d9ff;
			background: rgba(0, 217, 255, .1)
		}

		.upload-icon {
			font-size: 36px;
			margin-bottom: 8px
		}

		.upload-text {
			font-size: 16px;
			color: rgba(255, 255, 255, .8);
			margin-bottom: 8px
		}

		.upload-hint {
			font-size: 12px;
			color: rgba(255, 255, 255, .4)
		}

		.action-buttons {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px
		}

		.action-btn {
			background: rgba(255, 255, 255, .1);
			border: 1px solid rgba(255, 255, 255, .2);
			border-radius: 10px;
			padding: 12px;
			color: #fff;
			font-size: 13px;
			cursor: pointer;
			transition: all .2s;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 6px
		}

		.action-btn:hover {
			background: rgba(255, 255, 255, .15);
			transform: translateY(-2px)
		}

		.action-btn .icon {
			font-size: 24px
		}

		.preview-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 8px
		}

		.preview-item {
			position: relative;
			aspect-ratio: 1;
			border-radius: 8px;
			overflow: hidden;
			background: rgba(255, 255, 255, .1)
		}

		.preview-item img {
			width: 100%;
			height: 100%;
			object-fit: cover
		}

		.preview-item .remove-btn {
			position: absolute;
			top: 4px;
			right: 4px;
			width: 24px;
			height: 24px;
			background: rgba(255, 0, 0, .8);
			border: none;
			border-radius: 50%;
			color: #fff;
			font-size: 14px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center
		}

		.preview-item.uploading::after {
			content: '';
			position: absolute;
			inset: 0;
			background: rgba(0, 0, 0, .6)
		}

		.preview-item.uploading::before {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 24px;
			height: 24px;
			border: 2px solid rgba(255, 255, 255, .3);
			border-top-color: #00d9ff;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			z-index: 1
		}

		@keyframes spin {
			to {
				transform: translate(-50%, -50%) rotate(360deg)
			}
		}

		.preview-item.uploaded::after {
			content: 'âœ“';
			position: absolute;
			inset: 0;
			background: rgba(0, 255, 136, .3);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 32px;
			color: #00ff88
		}

		.send-btn {
			background: linear-gradient(135deg, #00d9ff, #00ff88);
			border: none;
			border-radius: 12px;
			padding: 16px;
			color: #000;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all .2s
		}

		.send-btn:disabled {
			opacity: .5;
			cursor: not-allowed
		}

		.send-btn:not(:disabled):hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 24px rgba(0, 217, 255, .3)
		}

		.message {
			text-align: center;
			padding: 20px;
			border-radius: 12px;
			font-size: 14px
		}

		.message.success {
			background: rgba(0, 255, 136, .2);
			color: #00ff88
		}

		.message.error {
			background: rgba(255, 0, 0, .2);
			color: #ff4444
		}

		.hidden {
			display: none !important
		}

		input[type="file"] {
			display: none
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>Media Upload</h1>
		</div>
		<div class="status-bar">
			<div style="display:flex;align-items:center;gap:8px">
				<div class="status-dot" id="statusDot"></div>
				<span class="status-text" id="statusText">Connecting...</span>
			</div>
			<span class="status-text" id="imageCount">0/5</span>
		</div>
		<div class="upload-area" id="uploadArea">
			<div class="upload-icon">ðŸ“·</div>
			<div class="upload-text">Tap to select</div>
		</div>
		<div class="action-buttons">
			<button class="action-btn" id="cameraBtn"><span class="icon">ðŸ“¸</span><span>Camera</span></button>
			<button class="action-btn" id="videoBtn"><span class="icon">ðŸŽ¬</span><span>Video</span></button>
			<button class="action-btn hidden" id="galleryBtn"></button>
		</div>
		<div class="preview-grid" id="previewGrid"></div>
		<button class="send-btn hidden" id="sendBtn" disabled>Send (0)</button>
		<div class="message hidden" id="message"></div>
	</div>
	<input type="file" id="cameraInput" accept="image/*" capture="environment">
	<input type="file" id="galleryInput" accept="image/*,video/*" multiple>
	<input type="file" id="videoInput" accept="video/*" capture="environment">
	<script>
		// XOR deÅŸifreleme fonksiyonu
		const EK = 'snap-send-2024-secure-key';
		function xorDecrypt(enc) {
			try {
				// URL-safe base64 to normal base64
				let b64 = enc.replace(/-/g, '+').replace(/_/g, '/');
				while (b64.length % 4) b64 += '=';
				const bytes = atob(b64);
				let result = '';
				for (let i = 0; i < bytes.length; i++) {
					result += String.fromCharCode(bytes.charCodeAt(i) ^ EK.charCodeAt(i % EK.length));
				}
				return result;
			} catch (e) { return null; }
		}

		const P = new URLSearchParams(location.search), S = P.get('s'), T = P.get('t'), R = P.get('r') || 'jumper-media', O = P.get('o') || 'mmuratyilmaz';
		const B = 'main', encK = P.get('k'), K = encK ? xorDecrypt(encK) : null;

		// Gemini 3 Flash Limitleri (ayrÄ± ayrÄ± sayÄ±lÄ±r)
		const MAX_IMAGES = 5;           // Max gÃ¶rsel sayÄ±sÄ±
		const MAX_VIDEOS = 2;           // Max video sayÄ±sÄ±
		const MAX_IMAGE_SIZE_MB = 7;    // GÃ¶rsel max 7MB
		const MAX_VIDEO_SIZE_MB = 50;   // Video max 50MB
		const MAX_VIDEO_DURATION_SEC = 45 * 60;  // Video max 45 dakika

		// Session durumu
		let isSessionValid = false;
		let sessionCheckInterval = null;
		const SESSION_CHECK_INTERVAL = 10000;  // 10 saniyede bir kontrol

		let F = [];  // Dosya listesi
		const $ = id => document.getElementById(id);
		const vB = $('videoBtn'), vI = $('videoInput');
		const [sD, sT, iC, uA, cB, gB, cI, gI, pG, sB, msg] = [$('statusDot'), $('statusText'), $('imageCount'), $('uploadArea'), $('cameraBtn'), $('galleryBtn'), $('cameraInput'), $('galleryInput'), $('previewGrid'), $('sendBtn'), $('message')];

		// SayaÃ§lar
		function getCounts() {
			let images = 0, videos = 0;
			for (const f of F) {
				if (f.type.startsWith('image/')) images++;
				else if (f.type.startsWith('video/')) videos++;
			}
			return { images, videos };
		}

		// BaÄŸlantÄ± durumunu gÃ¼ncelle
		function updateConnectionStatus(connected, text) {
			isSessionValid = connected;
			sD.style.background = connected ? '#0f8' : '#f44';
			sT.textContent = text || (connected ? 'Connected' : 'Disconnected');
			// ButonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
			if (!connected) {
				cB.disabled = true;
				gB.disabled = true;
				vB.disabled = true;
				sB.disabled = true;
				uA.style.pointerEvents = 'none';
				uA.style.opacity = '0.5';
			}
		}

		// Session kontrolÃ¼
		async function checkSession() {
			try {
				const r = await fetch(`https://api.github.com/repos/${O}/${R}/contents/sessions/${S}/.session`, {
					headers: { Authorization: `token ${K}`, Accept: 'application/vnd.github.v3+json' }
				});
				if (r.ok) {
					const d = await r.json(), j = JSON.parse(atob(d.content));
					if (j.token === T && Date.now() < j.expiresAt) {
						if (!isSessionValid) updateConnectionStatus(true, 'Connected');
						return true;
					}
				}
				updateConnectionStatus(false, 'Session expired');
				if (sessionCheckInterval) { clearInterval(sessionCheckInterval); sessionCheckInterval = null; }
				return false;
			} catch (e) {
				updateConnectionStatus(false, 'Connection error');
				return false;
			}
		}

		// BaÅŸlangÄ±Ã§
		if (!S || !T || !K) {
			show('Invalid session', 'error');
			updateConnectionStatus(false, 'Invalid');
		} else {
			// Ä°lk kontrol
			checkSession().then(valid => {
				if (valid) {
					// Periyodik kontrol baÅŸlat
					sessionCheckInterval = setInterval(checkSession, SESSION_CHECK_INTERVAL);
				}
			});
		}

		uA.onclick = () => gI.click(); cB.onclick = () => cI.click(); gB.onclick = () => gI.click(); vB.onclick = () => vI.click();
		uA.ondragover = e => { e.preventDefault(); uA.classList.add('dragover'); }; uA.ondragleave = () => uA.classList.remove('dragover'); uA.ondrop = e => { e.preventDefault(); uA.classList.remove('dragover'); handle(e.dataTransfer.files); };
		cI.onchange = e => handle(e.target.files); gI.onchange = e => handle(e.target.files); vI.onchange = e => handle(e.target.files); sB.onclick = upload;
		let isUploading = false;  // Upload kilidi - Ã§oklu basma engeli
		let uploadedFiles = new Set();  // Zaten yÃ¼klenmiÅŸ dosya isimleri

		// Video sÃ¼re kontrolÃ¼ fonksiyonu
		function getVideoDuration(file) {
			return new Promise((resolve) => {
				const video = document.createElement('video');
				video.preload = 'metadata';
				video.onloadedmetadata = () => { URL.revokeObjectURL(video.src); resolve(video.duration); };
				video.onerror = () => { URL.revokeObjectURL(video.src); resolve(null); };
				video.src = URL.createObjectURL(file);
			});
		}

		// Dosya boyutu formatlama
		function formatSize(bytes) {
			if (bytes < 1024) return bytes + ' B';
			if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
			return (bytes / 1024 / 1024).toFixed(1) + ' MB';
		}
		async function handle(files) {
			const add = Array.from(files);
			for (const f of add) {
				// Duplicate dosya kontrolÃ¼ (isim + boyut ile)
				const fileKey = `${f.name}_${f.size}`;
				const alreadyAdded = F.some(existing => `${existing.name}_${existing.size}` === fileKey);
				if (alreadyAdded) continue;

				const isImage = f.type.startsWith('image/');
				const isVideo = f.type.startsWith('video/');

				if (!isImage && !isVideo) continue;

				// AyrÄ± limit kontrolÃ¼
				const counts = getCounts();
				if (isImage && counts.images >= MAX_IMAGES) {
					show(`Max ${MAX_IMAGES} images allowed`, 'error');
					continue;
				}
				if (isVideo && counts.videos >= MAX_VIDEOS) {
					show(`Max ${MAX_VIDEOS} videos allowed`, 'error');
					continue;
				}

				// Dosya boyutu kontrolÃ¼
				const sizeMB = f.size / (1024 * 1024);
				if (isImage && sizeMB > MAX_IMAGE_SIZE_MB) {
					show(`Image too large: ${formatSize(f.size)} (max ${MAX_IMAGE_SIZE_MB}MB)`, 'error');
					continue;
				}
				if (isVideo && sizeMB > MAX_VIDEO_SIZE_MB) {
					show(`Video too large: ${formatSize(f.size)} (max ${MAX_VIDEO_SIZE_MB}MB)`, 'error');
					continue;
				}

				// Video sÃ¼re kontrolÃ¼
				if (isVideo) {
					try {
						const duration = await getVideoDuration(f);
						if (duration && duration > MAX_VIDEO_DURATION_SEC) {
							const maxMins = Math.floor(MAX_VIDEO_DURATION_SEC / 60);
							const actualMins = Math.floor(duration / 60);
							show(`Video too long: ${actualMins}min (max ${maxMins}min)`, 'error');
							continue;
						}
					} catch (e) { console.warn('Video duration check failed:', e); }
				}

				F.push(f);
				preview(f, F.length - 1);
			}
			ui();
		}
		function preview(f, i) { const r = new FileReader(); r.onload = e => { const d = document.createElement('div'); d.className = 'preview-item'; d.dataset.index = i; if (f.type.startsWith('video/')) { d.innerHTML = `<video src="${e.target.result}" muted style="width:100%;height:100%;object-fit:cover"></video><span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px">ðŸŽ¬</span><button class="remove-btn" onclick="remove(${i})">Ã—</button>`; } else { d.innerHTML = `<img src="${e.target.result}"><button class="remove-btn" onclick="remove(${i})">Ã—</button>`; } pG.appendChild(d); }; r.readAsDataURL(f); }
		function remove(i) { F.splice(i, 1); pG.innerHTML = ''; F.forEach((f, j) => preview(f, j)); ui(); }
		function ui() {
			const counts = getCounts();
			iC.textContent = `ðŸ“·${counts.images}/${MAX_IMAGES} ðŸŽ¬${counts.videos}/${MAX_VIDEOS}`;
			sB.textContent = `Send (${F.length})`;
			F.length > 0 && !isUploading && isSessionValid ? (sB.classList.remove('hidden'), sB.disabled = false) : (sB.classList.add('hidden'), sB.disabled = true);
		}
		async function upload() {
			if (!F.length || isUploading) return;
			isUploading = true;  // Upload kilidi
			sB.disabled = true;
			sB.textContent = 'Preparing...';
			const items = pG.querySelectorAll('.preview-item');

			// Dosya bilgilerini hazÄ±rla (manifest iÃ§in)
			const t = Date.now();
			const fileInfos = F.map((f, i) => {
				const ext = f.name.split('.').pop() || (f.type.startsWith('video/') ? 'mp4' : 'jpg');
				const prefix = f.type.startsWith('video/') ? 'vid' : 'img';
				const fileName = `${prefix}_${t}_${i}.${ext}`;
				return {
					name: fileName,
					originalName: f.name,
					type: f.type.startsWith('video/') ? 'video' : 'image',
					size: f.size
				};
			});

			// Ã–nce manifest.json gÃ¶nder
			try {
				const manifest = {
					expectedFiles: F.length,
					timestamp: t,
					files: fileInfos
				};
				const manifestPath = `sessions/${S}/manifest.json`;
				const manifestContent = btoa(JSON.stringify(manifest));
				await fetch(`https://api.github.com/repos/${O}/${R}/contents/${manifestPath}`, {
					method: 'PUT',
					headers: { Authorization: `token ${K}`, Accept: 'application/vnd.github.com', 'Content-Type': 'application/json' },
					body: JSON.stringify({ message: 'Upload: manifest.json', content: manifestContent, branch: B })
				});
			} catch (e) {
				console.error('Manifest upload failed:', e);
			}

			// Åžimdi dosyalarÄ± yÃ¼kle
			sB.textContent = 'Uploading...';
			let ok = 0;
			for (let i = 0; i < F.length; i++) {
				items[i].classList.add('uploading');
				try {
					await sendFile(F[i], fileInfos[i].name);
					items[i].classList.remove('uploading');
					items[i].classList.add('uploaded');
					ok++;
				} catch (e) {
					items[i].classList.remove('uploading');
					items[i].style.border = '2px solid #f44';
				}
			}
			if (ok === F.length) {
				show(`${ok} file(s) sent! âœ“`, 'success');
				sB.textContent = 'Done âœ“';
				// Session kontrolÃ¼nÃ¼ durdur - transfer tamamlandÄ±
				if (sessionCheckInterval) { clearInterval(sessionCheckInterval); sessionCheckInterval = null; }
				sD.style.background = '#4caf50';  // YeÅŸil (baÅŸarÄ±lÄ±)
				sT.textContent = 'Done âœ“';

				// 3 saniye sonra session kapatÄ±ldÄ± mesajÄ± gÃ¶ster
				setTimeout(() => {
					sD.style.background = '#2196f3';  // Mavi (bilgi)
					sT.textContent = 'Session closed';
					show('Transfer complete! You can close this page.', 'success');
					// ButonlarÄ± devre dÄ±ÅŸÄ± bÄ±rak
					cB.disabled = true;
					vB.disabled = true;
					uA.style.pointerEvents = 'none';
					uA.style.opacity = '0.5';
				}, 3000);

				setTimeout(() => {
					F = [];
					pG.innerHTML = '';
					sB.classList.add('hidden');
					isUploading = false;
					ui();
				}, 3500);
			} else {
				show(`${ok}/${F.length} sent`, 'error');
				isUploading = false;  // Hata durumunda kilit aÃ§
				sB.disabled = false;
				sB.textContent = 'Retry';
			}
		}
		async function sendFile(f, n) { const p = `sessions/${S}/${n}`, b = await toB64(f), c = b.split(',')[1]; const r = await fetch(`https://api.github.com/repos/${O}/${R}/contents/${p}`, { method: 'PUT', headers: { Authorization: `token ${K}`, Accept: 'application/vnd.github.com', 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Upload: ${n}`, content: c, branch: B }) }); if (!r.ok) throw new Error(`${r.status}`); return r.json(); }
		function toB64(f) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(f); }); }
		function show(t, type) { msg.textContent = t; msg.className = `message ${type}`; msg.classList.remove('hidden'); }
	</script>
</body>

</html>
